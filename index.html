<!doctype html>
<html lang="en">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CFB Content Queue</title>
<style>
  body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;max-width:800px;margin:32px auto;padding:0 16px}
  header{display:flex;align-items:center;gap:8px;margin-bottom:16px}
  .tabs{display:flex;gap:4px;margin-bottom:16px;border-bottom:1px solid #e5e7eb}
  .tab{padding:8px 16px;border:none;background:none;cursor:pointer;border-bottom:2px solid transparent;color:#6b7280}
  .tab.active{border-bottom-color:#3b82f6;color:#1f2937;font-weight:500}
  .tab:hover{color:#374151}
  .post{border:1px solid #e5e7eb;border-radius:12px;padding:12px 14px;margin:10px 0;display:flex;gap:10px;align-items:flex-start}
  .post.posted{opacity:0.6;background:#f8f9fa;border-color:#d1d5db}
  .meta{font-size:12px;color:#6b7280}
  button{padding:6px 10px;border-radius:8px;border:1px solid #d1d5db;background:#fff;cursor:pointer;margin-left:4px}
  button:hover{background:#f9fafb}
  button.posted{background:#e5e7eb;color:#6b7280;cursor:default}
  button.posted:hover{background:#e5e7eb}
  .tab-content{display:none}
  .tab-content.active{display:block}
  .button-group{display:flex;gap:4px}
</style>
<header>
  <h1 style="margin:0">CFB Content Queue</h1>
  <small id="ts" class="meta"></small>
  <button id="refresh">Refresh</button>
  <button id="clearPosted">Clear Posted</button>
</header>
<div class="tabs">
  <button class="tab active" data-tab="final">Final Scores</button>
  <button class="tab" data-tab="polls">Polls</button>
  <button class="tab" data-tab="betting">Betting Previews</button>
</div>
<div id="final-tab" class="tab-content active">
  <div id="final-list">Loading…</div>
</div>
<div id="polls-tab" class="tab-content">
  <div id="polls-list">Loading…</div>
</div>
<div id="betting-tab" class="tab-content">
  <div id="betting-list">Loading…</div>
</div>

<script>
const URL = "public/cfb_queue.json";

// Get posted items from localStorage
function getPostedItems() {
  try {
    return JSON.parse(localStorage.getItem('postedItems') || '[]');
  } catch {
    return [];
  }
}

// Save posted items to localStorage
function savePostedItems(items) {
  localStorage.setItem('postedItems', JSON.stringify(items));
}

// Mark an item as posted
function markAsPosted(postId) {
  const postedItems = getPostedItems();
  if (!postedItems.includes(postId)) {
    postedItems.push(postId);
    savePostedItems(postedItems);
    load(); // Reload to re-sort
  }
}

// Open Twitter with post content
function openTwitterPost(text) {
  const url = 'https://twitter.com/intent/tweet?text=' + encodeURIComponent(text);
  window.open(url, '_blank');
}

async function load() {
  const finalList = document.getElementById("final-list");
  const pollsList = document.getElementById("polls-list");
  const bettingList = document.getElementById("betting-list");
  finalList.textContent = "Loading…";
  pollsList.textContent = "Loading…";
  bettingList.textContent = "Loading…";
  
  try {
    const res = await fetch(URL + "?v=" + Date.now(), { cache: "no-store" });
    if (!res.ok) throw new Error(res.status + " " + res.statusText);
    const data = await res.json();

    document.getElementById("ts").textContent =
      `generated ${new Date(data.generatedAt).toLocaleString()}`;

    // Separate posts by type
    const finalPosts = data.posts?.filter(p => p.kind === "final") || [];
    const pollPosts = data.posts?.filter(p => p.kind === "poll_top10" || p.kind === "poll_movers") || [];
    const bettingPosts = data.posts?.filter(p => p.kind === "betting_preview") || [];

    // Sort posts: unposted first, then posted (by priority desc, then by original order)
    const postedItems = getPostedItems();
    const sortPosts = (posts) => {
      return posts.sort((a, b) => {
        const aPosted = postedItems.includes(a.id);
        const bPosted = postedItems.includes(b.id);
        
        if (aPosted && !bPosted) return 1;  // a goes after b
        if (!aPosted && bPosted) return -1; // a goes before b
        if (aPosted && bPosted) return 0;   // maintain order for posted items
        return b.priority - a.priority;     // sort by priority for unposted
      });
    };

    // Render final scores
    finalList.innerHTML = "";
    if (!finalPosts.length) {
      finalList.textContent = "No final score posts in queue.";
    } else {
      for (const p of sortPosts(finalPosts)) {
        finalList.appendChild(createPostElement(p));
      }
    }

    // Render poll posts
    pollsList.innerHTML = "";
    if (!pollPosts.length) {
      pollsList.textContent = "No poll posts in queue.";
    } else {
      for (const p of sortPosts(pollPosts)) {
        pollsList.appendChild(createPostElement(p));
      }
    }

    // Render betting preview posts
    bettingList.innerHTML = "";
    if (!bettingPosts.length) {
      bettingList.textContent = "No betting preview posts in queue.";
    } else {
      for (const p of sortPosts(bettingPosts)) {
        bettingList.appendChild(createPostElement(p));
      }
    }
  } catch (err) {
    finalList.textContent = "Could not load queue: " + err.message;
    pollsList.textContent = "Could not load queue: " + err.message;
    bettingList.textContent = "Could not load queue: " + err.message;
  }
}

function createPostElement(p) {
  const el = document.createElement("div");
  const postedItems = getPostedItems();
  const isPosted = postedItems.includes(p.id);
  
  el.className = `post${isPosted ? ' posted' : ''}`;
  el.innerHTML = `
    <div style="flex:1">
      <div>${(p.text||"").replace(/</g,"&lt;")}</div>
      <div class="meta">${p.kind} • priority ${p.priority}${
        p.link ? ` • <a href="${p.link}" target="_blank">boxscore</a>` : ""
      }${isPosted ? ' • <strong>POSTED</strong>' : ''}</div>
    </div>
    <div class="button-group">
      <button>Copy</button>
      <button>X</button>
      <button class="${isPosted ? 'posted' : ''}" ${isPosted ? 'disabled' : ''}>
        ${isPosted ? 'Posted' : 'Mark as Posted'}
      </button>
    </div>`;
  
  // Copy button functionality
  el.querySelector("button").onclick = async () => {
    await navigator.clipboard.writeText(p.text);
    el.querySelector("button").textContent = "Copied";
    setTimeout(()=>el.querySelector("button").textContent="Copy",900);
  };
  
  // X button functionality
  el.querySelectorAll("button")[1].onclick = () => {
    openTwitterPost(p.text);
  };
  
  // Mark as posted button functionality
  if (!isPosted) {
    el.querySelectorAll("button")[2].onclick = () => {
      markAsPosted(p.id);
    };
  }
  
  return el;
}
// Tab switching functionality
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    // Remove active class from all tabs and content
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    
    // Add active class to clicked tab and corresponding content
    tab.classList.add('active');
    document.getElementById(tab.dataset.tab + '-tab').classList.add('active');
  });
});

document.getElementById("refresh").onclick = load;
document.getElementById("clearPosted").onclick = () => {
  localStorage.removeItem('postedItems');
  console.log('Cleared posted items from localStorage');
  load();
};
load();
</script>
</html>
