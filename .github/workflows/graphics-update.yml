name: Update CFB Graphics

on:
  # Run Friday night (11 PM EST/EDT = 4 AM UTC Saturday), Saturday 4 PM (9 PM UTC), Saturday midnight (5 AM UTC Sunday)
  schedule:
    - cron: '0 4 * * 6'  # Friday 11 PM EST (4 AM UTC Saturday)
    - cron: '0 21 * * 6' # Saturday 4 PM EST (9 PM UTC Saturday) 
    - cron: '0 5 * * 0'  # Saturday midnight EST (5 AM UTC Sunday)
  # Allow manual trigger
  workflow_dispatch:
  # Run on push to main branch (for testing)
  push:
    branches: [ main ]
    paths:
      - 'graphics/scripts/**'
      - 'graphics/data/**'

jobs:
  update-graphics:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: 'graphics/package-lock.json'
        
    - name: Install dependencies
      run: |
        cd graphics
        npm install
        
    - name: Install Playwright browsers
      run: |
        cd graphics
        npx playwright install chromium
        
    - name: Test basic script execution
      run: |
        cd graphics
        echo "Testing Node.js and script access..."
        node --version
        ls -la scripts/
        echo "âœ… Basic setup complete"
        
    - name: Generate Team Graphics
      run: |
        cd graphics
        echo "ğŸ¨ Generating team graphics..."
        node scripts/generate-cfbd-leaders.mjs
        echo "âœ… Team graphics generated"
        
    - name: Generate Player Graphics
      run: |
        cd graphics
        echo "ğŸ¨ Generating player graphics..."
        node scripts/generate-player-leaders.mjs
        echo "âœ… Player graphics generated"
        
    - name: Move PNG files to root
      run: |
        cd graphics
        echo "ğŸ“ Moving PNG files to root level..."
        mv output/*.png ../
        echo "âœ… PNG files moved to root level"
        
    - name: Create graphics metadata
      run: |
        echo "ğŸ“ Creating graphics metadata..."
        node create-graphics-metadata.mjs
        echo "âœ… Graphics metadata created"
        
    - name: List Generated Files
      run: |
        echo "ğŸ“ Generated files in root:"
        ls -la *.png | head -20
        echo "Total PNG files: $(ls *.png | wc -l)"
        
    - name: Check for Changes
      id: changes
      run: |
        git add -f *.png
        if git diff --staged --quiet; then
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "ğŸ“ No changes detected in graphics"
        else
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "ğŸ“ Changes detected in graphics"
          git diff --staged --name-only
        fi
        
    - name: Commit Graphics Updates
      if: steps.changes.outputs.changed == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git commit -m "ğŸ¤– Auto-update CFB graphics - $(date '+%Y-%m-%d %H:%M')"
        echo "âœ… Graphics committed successfully"
        
    - name: Push Changes
      if: steps.changes.outputs.changed == 'true'
      run: |
        git push
        echo "âœ… Changes pushed to repository"
