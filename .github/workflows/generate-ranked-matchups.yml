name: Generate Ranked Matchups

on:
  schedule:
    # Generate ranked matchups on Sundays after polls are updated
    # Sunday 7:00 PM CST (1:00 AM UTC CDT / 2:00 AM UTC CST)
    - cron: '0 1 * * 1'  # Sunday 7pm CT (CDT) - Monday 1am UTC
    - cron: '0 2 * * 1'  # Sunday 7pm CT (CST) - Monday 2am UTC
  workflow_dispatch:
    inputs:
      reset_posted_ids:
        description: 'Reset posted_ids.json (for testing)'
        required: false
        default: false
        type: boolean

jobs:
  generate-ranked-matchups:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    concurrency:
      group: generate-ranked-matchups-${{ github.ref }}
      cancel-in-progress: false
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: 'graphics/package-lock.json'
        
    - name: Install dependencies
      run: |
        cd graphics
        npm install
        
    - name: Install Playwright browsers
      run: |
        cd graphics
        npx playwright install chromium
        
    - name: Reset posted_ids.json (if requested)
      if: ${{ inputs.reset_posted_ids == 'true' }}
      run: |
        echo '{"ids": []}' > posted_ids.json
        echo "âœ… Reset posted_ids.json"
        
    - name: Generate ranked matchups graphic
      run: |
        cd graphics
        echo "ğŸ¨ Generating ranked matchups graphic..."
        node scripts/generate-ranked-matchups-real.mjs
        echo "âœ… Ranked matchups graphic generated"
        
    - name: Move PNG files to root
      run: |
        cd graphics
        echo "ğŸ“ Moving PNG files to root level..."
        if [ -f "output/ranked-matchups-real.png" ]; then
          cp output/ranked-matchups-real.png ../
          echo "âœ… Ranked matchups PNG moved to root level"
        else
          echo "âš ï¸ No ranked matchups PNG found to move"
        fi
        
    - name: List Generated Files
      run: |
        echo "ğŸ“ Generated files in root:"
        ls -la ranked-matchups*.png || echo "No ranked matchups files found"
        
    - name: Check for Changes
      id: changes
      run: |
        git add -f ranked-matchups*.png
        if git diff --staged --quiet; then
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "ğŸ“ No changes detected in ranked matchups"
        else
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "ğŸ“ Changes detected in ranked matchups"
          git diff --staged --name-only
        fi
        
    - name: Commit Ranked Matchups Updates
      if: steps.changes.outputs.changed == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git commit -m "ğŸ¤– Auto-update ranked matchups - $(date '+%Y-%m-%d %H:%M')"
        echo "âœ… Ranked matchups committed successfully"
        
    - name: Push Changes
      if: steps.changes.outputs.changed == 'true'
      run: |
        git pull --rebase
        git push
        echo "âœ… Changes pushed to repository"
